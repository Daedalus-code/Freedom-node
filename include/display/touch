#!/bin/bash

################################################################################

source /etc/freedom-node/include/time_fix
source /etc/freedom-node/include/display/functions

################################################################################

exec 2>/dev/null
# restore terminal to sane state
trap 'sleep '"${TIME:?}"'; reset; stty sane; clear; tput rmcup' EXIT

# home directory
HOME_DIR="$(cat /etc/freedom-node/homedir 2>/dev/null)"
TOUCH_FILE="$HOME_DIR/node/touchcoords.tmp"
CONFIG_OUT="$HOME_DIR/node/touchconfig.tmp"

################################################################################

ZONES=(
  "Peers:2200:2660:2700:3060"     # connections
  "Balance:1950:1220:2450:1620"   # balances
  "Load:3100:1220:3300:1620"      # system load
  "Intranet:3350:3550:3550:3700"  # intranet
  "WAN:2420:1000:2650:1400"       # internet
  "TxCount:1950:1620:2550:2020"   # transactions
  "FreedomCoin:140:1870:800:2050" # logo
  "Hash:40:2100:4600:2250"        # tx hash
)

################################################################################

# if any data
if [[ -f "$HOME_DIR"/node/touchcoords.tmp ]] &>/dev/null; then
  # get last touch coordinates from tmp file (evtest listener should write here)
  read -r x y <"$HOME_DIR"/node/touchcoords.tmp || exit 0
  # check if the touch falls inside a zone
  for ZONE in "${ZONES[@]}"; do
    IFS=":" read -r LABEL x1 y1 x2 y2 <<<"$ZONE"
    if ((x >= x1 && x <= x2 && y >= y1 && y <= y2)); then
      # handle zone label (display dialog)
      handle_zone "$LABEL"

      ##########################################################################
      # touch configuration line
      ##########################################################################

      # wait for two touches
      echo "Waiting for first touch..." >"$CONFIG_OUT"
      while [[ ! -s $TOUCH_FILE ]]; do sleep 0.1; done
      read -r x1 y1 <"$TOUCH_FILE"
      >"$TOUCH_FILE"
      echo "First touch: $x1 $y1" >>"$CONFIG_OUT"
      echo "Waiting for second touch..." >>"$CONFIG_OUT"
      while [[ ! -s $TOUCH_FILE ]]; do sleep 0.1; done
      read -r x2 y2 <"$TOUCH_FILE"
      >"$TOUCH_FILE"
      echo "Second touch: $x2 $y2" >>"$CONFIG_OUT"
      # normalize coordinates (make sure x1 < x2 and y1 < y2)
      ((x1 > x2)) && tmp=$x1 && x1=$x2 && x2=$tmp
      ((y1 > y2)) && tmp=$y1 && y1=$y2 && y2=$tmp
      # append formatted config line
      echo "TOUCH:${x1}:${y1}:${x2}:${y2}" >>"$CONFIG_OUT"
    fi
  done
fi

# END
