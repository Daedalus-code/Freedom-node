#!/bin/bash

DEVICE="/dev/input/event0"
HOME_DIR="$(cat /etc/freedom-node/homedir 2>/dev/null)"

mkdir -p "$HOME_DIR"/node

evtest "$DEVICE" | while read -r LINE; do
  if [[ "$LINE" == *"ABS_X"* ]]; then
    x=$(echo "$LINE" | grep -oP 'value \K[0-9]+')
  elif [[ "$LINE" == *"ABS_Y"* ]]; then
    y=$(echo "$LINE" | grep -oP 'value \K[0-9]+')
    echo "$x $y" >"$HOME_DIR"/node/touchcoords.tmp
  elif [[ "$LINE" == *"ABS_PRESSURE"* ]]; then
    pressure=$(echo "$LINE" | grep -oP 'value \K[0-9]+')
    echo "$LABEL:$x:$pressure:$y:$pressure" >"$HOME_DIR"/node/touchconfig.tmp
    pkill -f /etc/freedom-node/include/touch
    bash /etc/freedom-node/include/touch &
  fi
done

# END
